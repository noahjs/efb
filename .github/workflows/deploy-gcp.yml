name: Deploy API and Worker (GCP)

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "api/**"
      - "hrrr-processor/**"
      - "ops/gcp/**"
      - ".dockerignore"
      - ".github/workflows/deploy-gcp.yml"

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Write deploy env file
        run: |
          cat > ops/gcp/gcp.env <<'EOF'
          PROJECT_ID=${{ vars.GCP_PROJECT_ID }}
          REGION=${{ vars.GCP_REGION }}
          AR_REPO=efb-api
          IMAGE_NAME=efb-api
          IMAGE_TAG=latest
          API_SERVICE_NAME=efb-api
          WORKER_SERVICE_NAME=efb-worker
          CLOUDSQL_INSTANCE=${{ vars.GCP_CLOUDSQL_INSTANCE }}
          API_MIN_INSTANCES=0
          API_MAX_INSTANCES=10
          API_MEMORY=1Gi
          WORKER_MIN_INSTANCES=1
          WORKER_MAX_INSTANCES=1
          WORKER_MEMORY=2Gi
          RUN_SERVICE_ACCOUNT=efb-runner@${{ vars.GCP_PROJECT_ID }}.iam.gserviceaccount.com
          SECRET_DB_USER=EFB_DB_USER
          SECRET_DB_PASS=EFB_DB_PASS
          SECRET_DB_NAME=EFB_DB_NAME
          SECRET_JWT_SECRET=EFB_JWT_SECRET
          SECRET_SCRAPINGBEE_API_KEY=EFB_SCRAPINGBEE_API_KEY
          SECRET_GOOGLE_CLIENT_ID=
          SECRET_APPLE_BUNDLE_ID=EFB_APPLE_BUNDLE_ID
          SECRET_LEIDOS_VENDOR_USER=
          SECRET_LEIDOS_VENDOR_PASS=
          SECRET_XWEATHER_CLIENT_ID=EFB_XWEATHER_CLIENT_ID
          SECRET_XWEATHER_CLIENT_SECRET=EFB_XWEATHER_CLIENT_SECRET
          SECRET_OPENAI_API_KEY=EFB_OPENAI_API_KEY
          SECRET_FIREBASE_SERVICE_ACCOUNT_JSON=
          CORS_ORIGINS=${{ vars.CORS_ORIGINS }}
          FILING_USE_MOCK=false
          LEIDOS_BASE_URL=https://lmfsweb.afss.com/Website/rest
          GCS_BUCKET=${{ vars.GCS_BUCKET }}
          GCS_ATIS_BUCKET=${{ vars.GCS_ATIS_BUCKET }}
          EOF

      - name: Deploy Cloud Run services
        run: bash ops/gcp/deploy-cloud-run.sh
